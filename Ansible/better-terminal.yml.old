---
- name: Install zoxide, fzf, and ranger
  hosts: all
  become: false  # Run tasks as the connected user, not as root
  vars:
    user_home: "{{ ansible_env.HOME }}"
  tasks:

    # ----------------------------
    # Install zoxide
    # ----------------------------

    - name: Check if zoxide is installed
      ansible.builtin.command: zoxide --version
      register: zoxide_installed
      ignore_errors: true

    - name: Install zoxide
      ansible.builtin.shell: |
        curl -sSfL https://raw.githubusercontent.com/ajeetdsouza/zoxide/main/install.sh | sh
      args:
        executable: /bin/bash
      when: zoxide_installed.failed

    - name: Add zoxide initialization to .bashrc
      ansible.builtin.lineinfile:
        path: "{{ user_home }}/.bashrc"
        create: true
        state: present
        line: 'eval "$(zoxide init bash)"'

    - name: Add zoxide init with custom command to .bashrc
      ansible.builtin.lineinfile:
        path: "{{ user_home }}/.bashrc"
        state: present
        line: 'eval "$(zoxide init bash --cmd cd)"'

    # ----------------------------
    # Install fzf
    # ----------------------------

    - name: Check if fzf is installed
      ansible.builtin.command: fzf --version
      register: fzf_installed
      ignore_errors: true

    - name: Clone fzf repository
      ansible.builtin.git:
        repo: 'https://github.com/junegunn/fzf.git'
        dest: "{{ user_home }}/.fzf"
        version: 'master'
        depth: 1
      when: fzf_installed.failed or not ansible_local.fzf_installed | default(false)

    - name: Install fzf non-interactively
      ansible.builtin.shell: "{{ user_home }}/.fzf/install --all"
      args:
        executable: /bin/bash
      when: fzf_installed.failed

    # ----------------------------
    # Install ranger
    # ----------------------------

    - name: Ensure package manager cache is up to date (Debian/Ubuntu)
      ansible.builtin.apt:
        update_cache: true
      when: ansible_facts.os_family == "Debian"

    - name: Ensure package manager cache is up to date (RedHat/CentOS)
      ansible.builtin.yum:
        name: '*'
        state: latest
      when: ansible_facts.os_family == "RedHat"

    - name: Install ranger via package manager
      ansible.builtin.package:
        name: ranger
        state: present

    # ----------------------------
    # Optional: Configure ranger (if needed)
    # ----------------------------
    # - name: Create ranger configuration directory
    #   file:
    #     path: "{{ user_home }}/.config/ranger"
    #     state: directory
    #
    # - name: Copy ranger configuration file
    #   copy:
    #     src: files/ranger/rc.conf
    #     dest: "{{ user_home }}/.config/ranger/rc.conf"
    #     owner: "{{ ansible_user }}"
    #     group: "{{ ansible_user }}"
    #     mode: '0644'

  # ----------------------------
  # Handlers (Removed as previously suggested)
  # ----------------------------
